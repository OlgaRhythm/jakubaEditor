<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JakubaEditor</title>

    <style>
        #editor {
            max-width: 50%; 
            width: 500px; 
            height: 200px; 
            border: 1px solid #000;
            padding: 10px 20px;
        }

        #toolbar {
            cursor: pointer;
            /*font-size: 16px;
            line-height: 26px;*/
            white-space: nowrap;
        }
        #toolbar button {
            display: block;
            cursor: pointer;
            font-family: inherit;
            margin: 0;
            padding: 0 5px;
            border: none;
            background: none;
            font-size: 16px;
            line-height: 26px;
        }
        #toolbar div {
            display: inline-block;
        }

        #toolbar div ul {
            width: 120px;
        }

        #toolbar div ul ul {
            width: auto;
        }

        #toolbar div ul, 
        #toolbar div ul ul,
        #toolbar div.active ul ul {
            display: none;
            border: #000 1px solid;
            padding: 0;
            margin: 0;
            cursor: pointer;
        }
        #toolbar div.active>ul,
        #toolbar div.active ul>li.active>ul {
            display: block;
            position: absolute;
            background: #fff;
        }
        #toolbar li {
            list-style: none;
            margin: 0;
            padding: 0;
        }
        #toolbar div ul li:hover {
            background: #ccc;
        }
        #toolbar div.active ul li ul {
            left: 100%;
            margin-top: -27px;
        }

    </style>

</head>
<body>

    <!-- Тестирование работы в редакторе -->
    <h1>Текстовый редактор JakubaEditor</h1>
    <form action="#" method="post" onsubmit="return save()">
<!-- ######################################################################################################################## -->       
    <textarea id="jakuba_editor_content" style="display: none;"></textarea>
    <!-- Toolbar -->
    <div id="toolbar">
        <div id="file"><button>File</button></div>
        <div id="edit"><button>Edit</button></div>
        <div id="view"><button>View</button></div>
        <div id="insert"><button>Insert</button></div>
        <div id="format"><button>Format</button>
            <ul>
                <li><button>Fonts sizes ></button>
                <ul>
                    <li style="font-size: 8pt;" onclick="setFontSize('8pt')"><button>8pt</button></li>
                    <li style="font-size: 10pt;" onclick="setFontSize('10pt')"><button>10pt</button></li>
                    <li style="font-size: 12pt;" onclick="setFontSize('12pt')"><button>12pt</button></li>
                    <li style="font-size: 14pt;" onclick="setFontSize('14pt')"><button>14pt</button></li>
                </ul>
                </li>
                <li><button>Fonts ></button>
                    <ul>
                        <li style="font-family: 'Times New Roman';">Times New Roman</li>
                        <li style="font-family: 'Arial';">Arial</li>
                    </ul>
                    </li>
            </ul>
        </div>
        <div id="help">Help</div>
    </div>
    <!-- Панель быстрого доступа -->
    <div id="quick-tools">           
        <button onclick="setBold()">Bold</button>
        <button onclick="setItalic()">Italic</button>
        <button onclick="setUnderline()">Underline</button>
        <button onclick="setStrikeThrough()">Strikethrough</button>
    </div>
    <div id="editor" contenteditable="true"><div>Type your text here...</div></div>

    <!-- Описание функций -->
    <script>
        // жирный шрифт, bold
        function setBold() {
            document.execCommand('bold', false, null);
        }
        // курсивный шрифт, italic
        function setItalic() {
            document.execCommand('italic', false, null);
        }
        // нижнее подчёркивание, underline
        function setUnderline() {
            document.execCommand('underline', false, null);
        }
        // зачёркивание текста, strikeThrough
        function setStrikeThrough() {
            document.execCommand('strikeThrough', false, null);
        }
        // размер шрифта
        function setFontSize(fontSizePt) {
            selection = window.getSelection().toString();
            wrappedselection = '<span style="font-size: ' + fontSizePt + '">' + selection + '</span>';
            document.execCommand('insertHTML', false, wrappedselection);
        }
        
        // обновление контента
        function updateHiddenText() {
            var editorContent = document.getElementById('editor').innerHTML;
            document.getElementById('jakuba_editor_content').value = editorContent;
        }

        // работа меню
        document.querySelectorAll("#toolbar>div").forEach(function(element) {
            element.addEventListener("click", function() {
                element.classList.add("active");
            });
        });

        document.querySelectorAll("#toolbar>div>ul>li").forEach(function(element) {
            element.addEventListener("click", function() {
                element.classList.toggle("active");
            });
        });

        document.addEventListener("mousedown", function(event) {
            var target = event.target;
            toolbarRemoveActive(target, "#toolbar>div>ul>li", "#toolbar>div, #toolbar>div>ul>li");
            toolbarRemoveActive(target, "#toolbar>div>ul>li>ul", "#toolbar>div>ul>li");
        });

        function toolbarRemoveActive(target, arg1, arg2) {
            var isInsideToolbarUl = target.closest(arg1);
            if (!isInsideToolbarUl) {
                document.querySelectorAll(arg2).forEach(function(element) {
                    element.classList.remove("active");
                });
            }
        }



        // Глобальная переменная для хранения текущего выделения
var currentSelection;

// Функция для сохранения текущего выделения
function saveSelection() {
    if (window.getSelection) {
        var selection = window.getSelection();
        if (selection.rangeCount > 0) {
            currentSelection = selection.getRangeAt(0);
        }
    }
}

// Функция для восстановления выделения
function restoreSelection() {
    if (currentSelection) {
        var selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(currentSelection);
    }
}

// Обработчик события mousedown для элементов вне текстового поля
document.addEventListener('mousedown', function(event) {
    var target = event.target;
    // Проверяем, что цель клика не находится внутри текстового поля
    if (!target.closest('#editor')) {
        // Восстанавливаем выделение
        restoreSelection();
    }
});

// Обработчик события click для текстового поля
document.getElementById('editor').addEventListener('click', function() {
    // Сохраняем текущее выделение
    saveSelection();
});


    </script>
<!-- ######################################################################################################################## --> 
    <script>
        function save() {
            var text = document.getElementById("jakuba_editor_content").value;
            var messageDiv = document.getElementById("result");
            messageDiv.innerHTML = text;
            return false;
        }
        function updateText() {
            updateHiddenText();
            save();
        }
    </script>

    <br>
    <button type="submit" onclick="updateText()">Обновить</button>
    </form>

    
    <!-- Результат работы -->
    <hr color="black" size="3" width="100%">
    <h1>Содержимое текстового редактора</h1>
    <div id="result"></div>
    
</body>
</html>